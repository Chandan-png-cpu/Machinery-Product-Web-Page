<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Settings - My Ceries</title>
    
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
<link rel="stylesheet" href="style.css"> 

    <style>
        :root { --primary-blue: #0A1F44; }
        .bg-dark { background-color: var(--primary-blue) !important; }
        .profile-page { min-height: 100vh; background-color: #f8f9fa; padding-top: 50px; }
        .card-header { background-color: var(--primary-blue); color: white; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">My Ceries</a>
            <button class="btn btn-sm btn-outline-light" id="logoutButton">Log Out</button>
        </div>
    </nav>
    <div class="profile-page container">
        
        <div class="row justify-content-center pt-5">
            <div class="col-lg-8">
                
                <h1 class="mb-4"><i class="fas fa-cog me-2"></i> Account Settings</h1>
                <p class="lead text-muted">Manage your personal details and change your password.</p>

                <div id="accessDenied" style="display: none;">
                    <div class="alert alert-danger text-center" role="alert">
                        You must be logged in to view this page. Please <a href="account.html">Log In</a>.
                    </div>
                </div>

                <div id="profileContent" style="display: none;">
                    
                    <div class="card shadow-sm mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Client Details</h5>
                        </div>
                        <div class="card-body">
                            <form id="profileDetailsForm" class="needs-validation" novalidate>
                                <div class="mb-3">
                                    <label for="profileCompanyName" class="form-label">Company Name</label>
                                    <input type="text" class="form-control" id="profileCompanyName" name="companyName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="profileFullName" class="form-label">Full Name</label>
                                    <input type="text" class="form-control" id="profileFullName" name="fullName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="profileEmail" class="form-label">Access Email</label>
                                    <input type="email" class="form-control" id="profileEmail" name="email" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Registered Since</label>
                                    <input type="text" class="form-control" id="profileRegistrationDate" readonly>
                                </div>
                                <button type="submit" class="btn btn-primary"><i class="fas fa-save me-2"></i> Update Details</button>
                            </form>
                        </div>
                    </div>

                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="mb-0">Change Password</h5>
                        </div>
                        <div class="card-body">
                            <form id="passwordChangeForm" class="needs-validation" novalidate>
                                <div class="mb-3">
                                    <label for="newPassword" class="form-label">New Password</label>
                                    <input type="password" class="form-control" id="newPassword" required minlength="6">
                                    <div class="invalid-feedback">Password must be at least 6 characters.</div>
                                </div>
                                <div class="mb-3">
                                    <label for="confirmNewPassword" class="form-label">Confirm New Password</label>
                                    <input type="password" class="form-control" id="confirmNewPassword" required>
                                    <div class="invalid-feedback" id="passwordMatchFeedback">Passwords must match.</div>
                                </div>
                                <button type="submit" class="btn btn-warning"><i class="fas fa-key me-2"></i> Change Password</button>
                            </form>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const currentUserData = sessionStorage.getItem('currentUser');
        const accessDenied = document.getElementById('accessDenied');
        const profileContent = document.getElementById('profileContent');
        const logoutButton = document.getElementById('logoutButton');

        if (!currentUserData) {
            // Not logged in: Show access denied
            accessDenied.style.display = 'block';
            logoutButton.style.display = 'none';
            return; 
        }

        // Logged in: Show content
        profileContent.style.display = 'block';
        logoutButton.style.display = 'block';
        let currentUser = JSON.parse(currentUserData); // Use let to allow modifications

        // 1. Populate Details Form
        const profileDetailsForm = document.getElementById('profileDetailsForm');
        document.getElementById('profileCompanyName').value = currentUser.companyName;
        document.getElementById('profileFullName').value = currentUser.fullName;
        document.getElementById('profileEmail').value = currentUser.email;
        document.getElementById('profileRegistrationDate').value = new Date(currentUser.registrationDate).toLocaleDateString();

        // 2. Handle Details Update
        profileDetailsForm.addEventListener('submit', function(event) {
            event.preventDefault();
            event.stopPropagation();
            
            if (profileDetailsForm.checkValidity()) {
                // Update the currentUser object
                currentUser.companyName = document.getElementById('profileCompanyName').value;
                currentUser.fullName = document.getElementById('profileFullName').value;
                currentUser.email = document.getElementById('profileEmail').value;

                // 2a. Update localStorage and sessionStorage
                let allUsers = JSON.parse(localStorage.getItem('registeredUsers') || '{}');
                // IMPORTANT: Remove the old entry and add the new one (in case email changed)
                // For this simulation, we'll assume the email field is the unique key
                
                // Remove old user data (using the original email as the key)
                const originalEmail = JSON.parse(sessionStorage.getItem('currentUser')).email;
                if (originalEmail !== currentUser.email) {
                    delete allUsers[originalEmail];
                }
                
                allUsers[currentUser.email] = {...currentUser, password: allUsers[originalEmail] ? allUsers[originalEmail].password : currentUser.password};
                
                // Ensure password is carried over (since it's not in the form)
                if (originalEmail !== currentUser.email && allUsers[originalEmail]) {
                     allUsers[currentUser.email].password = allUsers[originalEmail].password;
                } else if (!allUsers[currentUser.email].password) {
                     allUsers[currentUser.email].password = currentUser.password;
                }

                localStorage.setItem('registeredUsers', JSON.stringify(allUsers));
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser)); 
                
                alert('Account details updated successfully!');
                window.location.reload(); // Reload to refresh data and navbar name if needed

            }
            profileDetailsForm.classList.add('was-validated');
        });

        // 3. Handle Password Change
        const passwordChangeForm = document.getElementById('passwordChangeForm');
        passwordChangeForm.addEventListener('submit', function(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const newPassword = document.getElementById('newPassword');
            const confirmNewPassword = document.getElementById('confirmNewPassword');
            const passwordMatchFeedback = document.getElementById('passwordMatchFeedback');

            // Client-side validation: Password Match
            if (newPassword.value !== confirmNewPassword.value) {
                confirmNewPassword.setCustomValidity("Passwords must match.");
                passwordMatchFeedback.textContent = "Passwords must match.";
            } else {
                confirmNewPassword.setCustomValidity(""); 
            }

            if (passwordChangeForm.checkValidity()) {
                // 3a. Update currentUser object and persistent storage
                currentUser.password = newPassword.value;

                let allUsers = JSON.parse(localStorage.getItem('registeredUsers') || '{}');
                allUsers[currentUser.email] = currentUser; // Update the user entry with the new password
                localStorage.setItem('registeredUsers', JSON.stringify(allUsers));
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser)); // Update session data
                
                alert('Password changed successfully! Please log in again.');
                sessionStorage.removeItem('currentUser');
                window.location.href = 'account.html'; // Force relogin after password change

            }
            passwordChangeForm.classList.add('was-validated');
        });
        
        // 4. Handle Logout
        logoutButton.addEventListener('click', function() {
            sessionStorage.removeItem('currentUser');
            alert('You have been successfully logged out.');
            window.location.href = 'account.html';
        });
    });
</script>
</body>
</html>